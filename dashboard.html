<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Input Amalan</title>
    <meta name="theme-color" content="#047857"> 
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --bg-main: #f6f7f4; --bg-card: #ffffff; --text-main: #1f2937; }
        body { background: var(--bg-main); color: var(--text-main); font-family: sans-serif; padding-bottom: 110px; }

        input[type="date"] { background: transparent; color: white; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); opacity: 0.85; cursor: pointer; }
    </style>
</head>
<body>

<!-- HEADER -->
<div class="text-white p-6 pb-8 rounded-b-[2.5rem] shadow-xl mb-6 sticky top-0 z-40 bg-[#047857]">
    <div class="flex justify-between items-center mb-4">
        <div>
            <h1 class="font-bold text-2xl">Input Amalan</h1>
            <p class="text-emerald-100 text-xs mt-1 opacity-90">Isi target harianmu</p>
        </div>
        <button onclick="showLogoutModal()" class="bg-black/20 p-3 rounded-2xl text-xs">
            <i class="fa-solid fa-power-off"></i>
        </button>
    </div>

    <div class="mt-4 bg-white/10 backdrop-blur-md rounded-2xl p-3 border border-white/20">
        <p class="text-[10px] text-emerald-100 opacity-80 uppercase font-bold">Pilih Tanggal</p>
        <div class="flex items-center gap-2 mt-1">
            <i class="fa-solid fa-calendar-day text-white/80 text-sm"></i>
            <input type="date" id="datePicker" class="flex-1 bg-transparent text-white font-bold text-sm outline-none [color-scheme:dark]" />
        </div>
    </div>

</div>

<div id="inputContainer" class="px-4 max-w-md mx-auto space-y-3 -mt-2"></div>

<!-- NAVBAR -->
<div class="fixed bottom-6 left-4 right-4 bg-white/90 backdrop-blur-xl rounded-3xl shadow-2xl border border-gray-100 max-w-md mx-auto z-50">
    <div class="flex justify-between px-6 py-3">
        <a href="dashboard.html" class="flex flex-col items-center transition text-emerald-700">
            <div class="w-10 h-10 rounded-2xl flex items-center justify-center bg-emerald-100 text-emerald-700 shadow-sm">
                <i class="fa-solid fa-pen-to-square text-xl mb-1"></i>
            </div>
            <span class="text-[10px] font-bold">Input</span>
        </a>
        <a href="rekap.html" class="flex flex-col items-center transition text-gray-400 hover:text-emerald-600 group">
            <div class="w-10 h-10 rounded-2xl flex items-center justify-center bg-transparent group-hover:bg-emerald-50 transition">
                <i class="fa-solid fa-book-open text-xl mb-1"></i>
            </div>
            <span class="text-[10px] font-bold">Jurnal</span>
        </a>
        <a href="stats.html" class="flex flex-col items-center transition text-gray-400 hover:text-emerald-600 group">
            <div class="w-10 h-10 rounded-2xl flex items-center justify-center bg-transparent group-hover:bg-emerald-50 transition">
                <i class="fa-solid fa-chart-pie text-xl mb-1"></i>
            </div>
            <span class="text-[10px] font-bold">Statistik</span>
        </a>
    </div>
</div>

<!-- LOGOUT MODAL -->
<div id="logoutModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
  <div class="bg-white p-6 rounded-3xl w-4/5 max-w-xs shadow-2xl transform scale-95 transition-transform duration-300" id="logoutCard">
    <div class="text-center">
      <div class="w-16 h-16 bg-rose-100 text-rose-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
        <i class="fa-solid fa-right-from-bracket"></i>
      </div>
      <h3 class="font-bold text-gray-800 text-lg">Ingin Keluar?</h3>
      <p class="text-gray-500 text-xs mt-2 mb-6 leading-relaxed">Sesi anda akan diakhiri dan anda harus login kembali untuk mengakses data.</p>
      <div class="flex gap-3">
        <button onclick="closeLogoutModal()" class="flex-1 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl font-bold text-sm transition">Batal</button>
        <button onclick="confirmLogout()" class="flex-1 py-3 bg-rose-600 hover:bg-rose-700 text-white rounded-xl font-bold text-sm transition shadow-lg shadow-rose-200">Keluar</button>
      </div>
    </div>
  </div>
</div>

<script src="config.js"></script>
<script>
let user = null;

async function boot() {
  user = await requireAuth('index.html');
  
            initAutoLogout({ minutes: 5, redirect: 'index.html' });
if (!user) return;
}
function showLogoutModal() {
  const m = document.getElementById('logoutModal');
  const c = document.getElementById('logoutCard');
  m.classList.remove('hidden');
  setTimeout(() => {
    m.classList.remove('opacity-0');
    c.classList.remove('scale-95');
    c.classList.add('scale-100');
  }, 10);
}

function closeLogoutModal() {
  const m = document.getElementById('logoutModal');
  const c = document.getElementById('logoutCard');
  m.classList.add('opacity-0');
  c.classList.remove('scale-100');
  c.classList.add('scale-95');
  setTimeout(() => m.classList.add('hidden'), 300);
}

function confirmLogout() { logout(); }

let ITEMS = [];
let ITEM_MAP = {};
let currentData = {};
let saveTimer = null;

/* ===== DATE ===== */
const today = new Date();
const offset = today.getTimezoneOffset() * 60000;
const localISO = new Date(today.getTime() - offset).toISOString().split('T')[0];
datePicker.value = localISO;
datePicker.addEventListener('change', () => init());

function isFriday(dateISO) {
  const d = new Date(dateISO + "T00:00:00+07:00");
  return d.getDay() === 5;
}

/* ===== INIT ===== */
async function init() {
    const dateStr = datePicker.value;
    const friday = isFriday(dateStr);

    const { data } = await db
      .from('yaumiyyah_items')
      .select('*')
      .eq('is_active', true)
      .order('sort_order');

    ITEMS = (data || []).filter(it => {
      if (it.category === 'jumat') return friday;
      return true;
    });

    // Override label + target_min untuk item-item kunci (lihat config.js)
    if (window.applyYaumiyyahOverrides) window.applyYaumiyyahOverrides(ITEMS);

    ITEM_MAP = Object.fromEntries((ITEMS || []).map(it => [it.code, it]));

    loadData(dateStr);
}

/* ===== LOAD DATA (FIX 406) ===== */
async function loadData(dateStr) {
    currentData = {};
    try {
        const { data } = await db
          .from('yaumiyyah_daily')
          .select('checks')
          .eq('user_id', user.id)
          .eq('log_date', dateStr)
          .maybeSingle();

        if (data?.checks) currentData = data.checks;
    } catch(e){}
    renderUI();
}

/* ===== RENDER ===== */
function renderUI() {
    const c = inputContainer;
    c.innerHTML = '';

    ITEMS.forEach(item => {
        let val = currentData[item.code];
        const iconCls = item.icon || 'fa-star';

        // Label bawah: menggantikan kategori (shalat/ibadah/dll)
        const title = item.display_name || item.name || '';
        const subtitle = item.display_note || (item.input_type === 'bool'
          ? 'Ya/Tidak'
          : (item.target_min ? `Min ${item.target_min}` : 'Input angka'));

        const btnCls = "w-10 h-10 rounded-xl bg-gray-100 hover:bg-gray-200 active:scale-95 transition text-gray-700 font-extrabold";
        const valCls = "min-w-[64px] text-center font-extrabold text-sm";

        let controlHTML = '';
        if (item.input_type === 'bool') {
            const cur = (typeof val === 'number') ? val : (val === true ? 1 : 0);
            const labelVal = cur === 1 ? 'Ya' : 'Tidak';
            controlHTML = `
              <div class="flex items-center gap-2">
                <button class="${btnCls}" onclick="step('${item.code}', -1)">-</button>
                <div class="${valCls}">${labelVal}</div>
                <button class="${btnCls}" onclick="step('${item.code}', +1)">+</button>
              </div>`;
        } else {
            const num = typeof val === 'number' ? val : 0;
            const max = (typeof item.target_max === 'number') ? item.target_max : null;
            const maxArg = (max === null ? 'null' : String(max));
            controlHTML = `
              <div class="flex items-center gap-2">
                <button class="${btnCls}" onclick="step('${item.code}', -1, ${maxArg})">-</button>
                <div class="${valCls}">${num}</div>
                <button class="${btnCls}" onclick="step('${item.code}', +1, ${maxArg})">+</button>
              </div>`;
        }

        c.innerHTML += `
          <div class="bg-white p-4 rounded-2xl shadow border flex justify-between">
            <div class="flex gap-3 items-center">
              <div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-emerald-600">
                <i class="fa-solid ${iconCls}"></i>
              </div>
              <div>
                <h4 class="font-bold text-sm">${title}</h4>
                <p class="text-[10px] text-gray-400">${subtitle}</p>
              </div>
            </div>
            ${controlHTML}
          </div>`;
    });
}

/* ===== STEP (for +/- controls) ===== */
function step(key, delta, max) {
    const item = ITEM_MAP[key] || {};
    if (item.input_type === 'bool') {
        const next = delta > 0 ? 1 : 0; // + => Ya, - => Tidak
        update(key, next);
        return;
    }
    const cur = typeof currentData[key] === 'number' ? currentData[key] : 0;
    let next = cur + (delta || 0);
    if (next < 0) next = 0;

    if (typeof max === 'number' && !Number.isNaN(max) && next > max) next = max;
    update(key, next, max);
}


/* ===== UPDATE ===== */
function update(key, val, max) {
    const item = ITEM_MAP[key] || {};
    if (item.input_type === 'bool') {
        val = (val === true || Number(val) === 1) ? 1 : 0;
    } else if (typeof val === 'number') {
        if (val < 0) val = 0;
        if (typeof max === 'number' && !Number.isNaN(max) && val > max) val = max;
    }
    currentData[key] = val;
    renderUI();
    clearTimeout(saveTimer);
    saveTimer = setTimeout(saveToDB, 400);
}

async function saveToDB() {
    await db.from('yaumiyyah_daily').upsert({
        user_id: user.id,
        log_date: datePicker.value,
        checks: currentData,
        filled_at: new Date().toISOString()
    }, { onConflict:'user_id,log_date' });
}

init();
window.addEventListener("DOMContentLoaded", boot);
</script>
</body>
</html>
