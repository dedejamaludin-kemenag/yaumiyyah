<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Statistik Ibadah</title>
    <meta name="theme-color" content="#047857"> <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg-main: #f6f7f4; --bg-card: #ffffff; --text-main: #1f2937; }
        body { background: var(--bg-main); color: var(--text-main); font-family: sans-serif; padding-bottom: 110px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <div class="text-white p-6 pb-8 rounded-b-[2.5rem] shadow-xl mb-6 sticky top-0 z-40 bg-[#047857]">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="font-bold text-2xl">Statistik Bulanan</h1>
                <p class="text-emerald-100 text-xs mt-1 opacity-90">Pantau konsistensi ibadahmu</p>
            </div>
            <button onclick="showLogoutModal()" class="bg-black/20 backdrop-blur-sm p-3 rounded-2xl text-xs hover:bg-black/30 transition shadow-sm border border-white/10">
                <i class="fa-solid fa-power-off text-white"></i>
            </button>
        </div>
        
        <!-- Month picker -->
<div class="mt-4 bg-white/10 backdrop-blur-md rounded-2xl p-3 border border-white/20">
    <p class="text-[10px] text-emerald-100 opacity-80 uppercase font-bold">Pilih Bulan</p>
    <div class="flex items-center gap-2 mt-1">
        <i class="fa-solid fa-calendar-days text-white/80 text-sm"></i>
        <input id="monthPicker" type="month" class="flex-1 bg-transparent text-white font-bold text-sm outline-none [color-scheme:dark]" />
    </div>
</div>

<div class="grid grid-cols-2 gap-3 mt-6">
            <div class="bg-white/10 backdrop-blur-md rounded-2xl p-3 border border-white/20"><p class="text-[10px] text-emerald-100 opacity-80 uppercase font-bold">Total Pengisian</p><p class="text-2xl font-black mt-1" id="totalDays">-</p></div>
            <div class="bg-white/10 backdrop-blur-md rounded-2xl p-3 border border-white/20"><p class="text-[10px] text-emerald-100 opacity-80 uppercase font-bold">Rata-rata Capaian</p><p class="text-2xl font-black mt-1" id="avgScore">-%</p></div>
        </div>
    </div>

    <div id="statsContainer" class="px-4 max-w-md mx-auto space-y-4 -mt-2"><div class="text-center py-10 opacity-60"><i class="fa-solid fa-circle-notch fa-spin text-2xl text-emerald-600 mb-2"></i><p class="text-sm">Menghitung statistik...</p></div></div>

    <div class="fixed bottom-6 left-4 right-4 bg-white/90 backdrop-blur-xl rounded-3xl shadow-2xl border border-gray-100 max-w-md mx-auto z-50">
        <div class="flex justify-between px-6 py-3">
            <a href="dashboard.html" class="flex flex-col items-center transition text-gray-400 hover:text-emerald-600 group"><div class="w-10 h-10 rounded-2xl flex items-center justify-center bg-transparent group-hover:bg-emerald-50 transition"><i class="fa-solid fa-pen-to-square text-xl mb-1"></i></div><span class="text-[10px] font-bold">Input</span></a>
            <a href="rekap.html" class="flex flex-col items-center transition text-gray-400 hover:text-emerald-600 group"><div class="w-10 h-10 rounded-2xl flex items-center justify-center bg-transparent group-hover:bg-emerald-50 transition"><i class="fa-solid fa-book-open text-xl mb-1"></i></div><span class="text-[10px] font-bold">Jurnal</span></a>
            <a href="stats.html" class="flex flex-col items-center transition text-emerald-700"><div class="w-10 h-10 rounded-2xl flex items-center justify-center bg-emerald-100 text-emerald-700 shadow-sm"><i class="fa-solid fa-chart-pie text-xl mb-1"></i></div><span class="text-[10px] font-bold">Statistik</span></a>
        </div>
    </div>

    <div id="logoutModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white p-6 rounded-3xl w-4/5 max-w-xs shadow-2xl transform scale-95 transition-transform duration-300" id="logoutCard">
            <div class="text-center">
                <div class="w-16 h-16 bg-rose-100 text-rose-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl"><i class="fa-solid fa-right-from-bracket"></i></div>
                <h3 class="font-bold text-gray-800 text-lg">Ingin Keluar?</h3>
                <p class="text-gray-500 text-xs mt-2 mb-6 leading-relaxed">Sesi anda akan diakhiri dan anda harus login kembali untuk mengakses data.</p>
                <div class="flex gap-3">
                    <button onclick="closeLogoutModal()" class="flex-1 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl font-bold text-sm transition">Batal</button>
                    <button onclick="confirmLogout()" class="flex-1 py-3 bg-rose-600 hover:bg-rose-700 text-white rounded-xl font-bold text-sm transition shadow-lg shadow-rose-200">Keluar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        let user = null;

        async function boot() {
            user = await requireAuth('index.html');
            
            initAutoLogout({ minutes: 5, redirect: 'index.html' });
if (!user) return;
            init();
        }
function showLogoutModal() { const m = document.getElementById('logoutModal'), c = document.getElementById('logoutCard'); m.classList.remove('hidden'); setTimeout(()=> { m.classList.remove('opacity-0'); c.classList.remove('scale-95'); c.classList.add('scale-100');}, 10);}
        function closeLogoutModal() { const m = document.getElementById('logoutModal'), c = document.getElementById('logoutCard'); m.classList.add('opacity-0'); c.classList.remove('scale-100'); c.classList.add('scale-95'); setTimeout(()=> m.classList.add('hidden'), 300);}
        function confirmLogout() { logout(); }

        

const pad2 = (n) => String(n).padStart(2,'0');
const formatYMD = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
let __itemsCache = null;

const formatYM  = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;

async function fetchMonthSummary(ym) {
    // ym: YYYY-MM
    const [Y,M] = ym.split('-').map(Number);
    const monthDate = `${Y}-${pad2(M)}-01`;

    // 1) try table summary (trigger)
    let res = await db
      .from('yaumiyyah_daily_summary')
      .select('filled, progress_pct')
      .eq('user_id', user.id)
      .gte('log_date', monthDate)
      .lt('log_date', formatYMD(new Date(Y, M, 1)));

    if (!res.error) {
        const rows = res.data || [];
        const filled = rows.filter(r => r.filled);
        const daysFilled = filled.length;
        const avg = daysFilled ? Math.round(filled.reduce((a,r)=>a+(r.progress_pct||0),0)/daysFilled) : 0;
        return { daysFilled, avg };
    }

    // 2) fallback to monthly view (kalau table belum/grant ketat)
    const res2 = await db
      .from('yaumiyyah_v_monthly_summary')
      .select('days_filled, avg_progress_pct')
      .eq('user_id', user.id)
      .eq('month', monthDate)
      .maybeSingle();

    if (res2.error) throw res2.error;

    return {
        daysFilled: res2.data?.days_filled || 0,
        avg: res2.data?.avg_progress_pct || 0
    };
}

async function loadMonth(ym) {
    const container = document.getElementById('statsContainer');
    if (container) {
        container.innerHTML = `
          <div class="bg-white rounded-3xl p-4 shadow-sm border border-gray-100">
            <div class="text-center py-6 opacity-70">
              <i class="fa-solid fa-circle-notch fa-spin text-2xl text-emerald-600 mb-2"></i>
              <p class="text-sm font-bold text-gray-700">Mengambil statistikâ€¦</p>
              <p class="text-xs text-gray-500 mt-1">Mohon tunggu sebentar</p>
            </div>
          </div>`;
    }

    try {
        // Summary cepat (kartu header)
        const sum = await fetchMonthSummary(ym);
        document.getElementById('totalDays').innerText = `${sum.daysFilled} Hari`;
        document.getElementById('avgScore').innerText = `${sum.avg}%`;

        // Ambil items + logs untuk ranking konsistensi (UI lama)
        let items = __itemsCache;
if (!items) {
    const { data: itemsData, error: itemsErr } = await db
        .from('yaumiyyah_items')
        .select('id, code, name, category, weight, is_active, sort_order, input_type, target_min, target_max, unit, icon')
        .eq('is_active', true)
        .order('sort_order');
    if (itemsErr) throw itemsErr;
    items = itemsData || [];
    if (window.applyYaumiyyahOverrides) window.applyYaumiyyahOverrides(items);
    __itemsCache = items;
}
const [Y, M] = ym.split('-').map(Number);
        const start = new Date(Y, M - 1, 1);
        const end = new Date(Y, M, 1);

        const startStr = formatYMD(start);
        const endStr   = formatYMD(end);

        const { data: logs, error: logsErr } = await db
            .from('yaumiyyah_daily')
            .select('log_date, checks')
            .eq('user_id', user.id)
            .gte('log_date', startStr)
            .lt('log_date', endStr)
            .order('log_date', { ascending: true });
        if (logsErr) throw logsErr;

        calculateStats(items || [], logs || []);
    } catch (err) {
        console.error(err);
        // jangan stuck: tampilkan error di UI
        const container = document.getElementById('statsContainer');
        if (container) {
            const detail = err && (err.message || err.toString()) ? (err.message || err.toString()) : '';
            container.innerHTML = `
              <div class="bg-white rounded-3xl p-4 shadow-sm border border-rose-200">
                <h3 class="font-black text-rose-700 text-sm"><i class="fa-solid fa-triangle-exclamation mr-2"></i>Statistik gagal dimuat</h3>
                <p class="text-[12px] text-rose-600/80 mt-2">Biasanya karena policy/grant (RLS) atau config Supabase.</p>
                ${detail ? `<pre class="mt-3 text-[11px] bg-rose-50 border border-rose-100 rounded-2xl p-3 overflow-auto">${detail}</pre>` : ''}
              </div>`;
        }
        // fallback angka
        const td = document.getElementById('totalDays'); if (td) td.innerText = `0 Hari`;
        const av = document.getElementById('avgScore'); if (av) av.innerText = `0%`;
    }
}

async function init() {
    const mp = document.getElementById('monthPicker');
    const now = new Date();
    const ym = formatYM(now);

    if (mp) {
        mp.value = mp.value || ym;
        mp.addEventListener('change', (e) => {
            if (e.target.value) loadMonth(e.target.value);
        });
        await loadMonth(mp.value);
    } else {
        await loadMonth(ym);
    }
}

        function calculateStats(items, logs) {
            const container = document.getElementById('statsContainer');

            const norm = (x) => String(x || '').toLowerCase().replace(/[^a-z0-9]/g,'');
            const hasAnyInput = (checks) => {
                if (!checks) return false;
                for (const v of Object.values(checks)) {
                    if (v === true) return true;
                    if (v === 1) return true;
                    if (typeof v === 'number' && v > 0) return true;
                }
                return false;
            };

            // hanya hari yang benar-benar diisi (minimal 1 input bermakna)
            const filledLogs = (logs || []).filter(l => l && hasAnyInput(l.checks));

            if (filledLogs.length === 0) {
                container.innerHTML = '<div class="text-center py-10 bg-white rounded-2xl"><p class="text-gray-400 text-sm">Belum ada cukup data bulan ini.</p></div>';
                document.getElementById('totalDays').innerText = "0 Hari";
                document.getElementById('avgScore').innerText = "0%";
                return;
            }

            // Denominator (pembagi):
            // - daily: jumlah hari yang diisi
            // - weekly: jumlah pekan yang diisi (distinct week)
            // - friday-only: jumlah Jumat yang diisi
            const weekKey = (dateStr) => {
                const parts = dateStr.split('-').map(Number);
                const d = new Date(parts[0], parts[1]-1, parts[2]);
                const tmp = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                const day = tmp.getUTCDay() || 7; // Mon=1..Sun=7
                tmp.setUTCDate(tmp.getUTCDate() + 4 - day);
                const yearStart = new Date(Date.UTC(tmp.getUTCFullYear(),0,1));
                const weekNo = Math.ceil((((tmp - yearStart) / 86400000) + 1) / 7);
                return `${tmp.getUTCFullYear()}-W${String(weekNo).padStart(2,'0')}`;
            };

            const weeks = new Set();
            const fridays = new Set();
            filledLogs.forEach(l => {
                weeks.add(weekKey(l.log_date));
                const parts = l.log_date.split('-').map(Number);
                const d = new Date(parts[0], parts[1]-1, parts[2]);
                if (d.getDay() === 5) fridays.add(l.log_date);
            });

            const denomDaily = filledLogs.length;
            const denomWeekly = weeks.size;
            const denomFriday = fridays.size;

            const detectMode = (item) => {
                if (item.calc_mode) return item.calc_mode; // daily / weekly / friday
                const k = norm(item.code);
                if (k === 'puasa' || k === 'olahraga') return 'weekly';
                if (k.includes('jumat') || k.includes('jumuah') || k.includes('kahfi') || k.includes('alkahfi') || k.includes('shalawatjumat')) return 'friday';
                return 'daily';
            };

            // Pre-index by date for quick access
            const byDate = new Map(filledLogs.map(l => [l.log_date, l.checks || {}]));

            const itemStats = (items || []).map(item => {
                const target = item.target_min || 1;
                const mode = detectMode(item);

                let successCount = 0;
                let denom = denomDaily;

                if (mode === 'weekly') {
                    denom = denomWeekly;

                    // week => success?
                    const wkSuccess = new Map();
                    filledLogs.forEach(l => {
                        const wk = weekKey(l.log_date);
                        if (!wkSuccess.has(wk)) wkSuccess.set(wk, false);

                        const checks = l.checks || {};
                        const raw = checks[item.code];
                        const val = (raw === true) ? 1 : (typeof raw === 'number' ? raw : 0);
                        if (val >= target) wkSuccess.set(wk, true);
                    });

                    wkSuccess.forEach(v => { if (v) successCount++; });

                } else if (mode === 'friday') {
                    denom = denomFriday;

                    // hanya Jumat yang diisi
                    fridays.forEach(dateStr => {
                        const checks = byDate.get(dateStr) || {};
                        const raw = checks[item.code];
                        const val = (raw === true) ? 1 : (typeof raw === 'number' ? raw : 0);
                        if (val >= target) successCount++;
                    });

                } else {
                    // daily
                    denom = denomDaily;
                    filledLogs.forEach(l => {
                        const checks = l.checks || {};
                        const raw = checks[item.code];
                        const val = (raw === true) ? 1 : (typeof raw === 'number' ? raw : 0);
                        if (val >= target) successCount++;
                    });
                }

                const percentage = denom > 0 ? Math.round((successCount / denom) * 100) : 0;
                return { ...item, percentage, _mode: mode };
            });

            itemStats.sort((a, b) => b.percentage - a.percentage);

            const avgScore = Math.round(itemStats.reduce((acc, curr) => acc + curr.percentage, 0) / (itemStats.length || 1));

            document.getElementById('totalDays').innerText = denomDaily + " Hari";
            document.getElementById('avgScore').innerText = avgScore + "%";

            const modeTag = (m) => {
                if (m === 'weekly') return '<span class="text-[10px] ml-2 px-2 py-0.5 rounded-full bg-gray-100 text-gray-600 font-bold">Pekan</span>';
                if (m === 'friday') return '<span class="text-[10px] ml-2 px-2 py-0.5 rounded-full bg-gray-100 text-gray-600 font-bold">Jumat</span>';
                return '';
            };

            let listHTML = itemStats.map((item, idx) => {
                let colorClass = "text-emerald-600", barClass = "bg-emerald-500";
                if(item.percentage < 50) { colorClass = "text-rose-500"; barClass = "bg-rose-500"; } else if(item.percentage < 80) { colorClass = "text-amber-500"; barClass = "bg-amber-500"; }
                return `
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-8 text-center text-xs font-bold text-gray-400">#${idx + 1}</div>
                    <div class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-500 shadow-sm border border-gray-100"><i class="fa-solid ${item.icon} text-xs"></i></div>
                    <div class="flex-1">
                        <div class="flex justify-between mb-1">
                            <span class="text-xs font-bold text-gray-700">${item.name}${modeTag(item._mode)}</span>
                            <span class="text-xs font-bold ${colorClass}">${item.percentage}%</span>
                        </div>
                        <div class="w-full h-1.5 bg-gray-100 rounded-full overflow-hidden">
                            <div class="h-full ${barClass} rounded-full" style="width: ${item.percentage}%"></div>
                        </div>
                    </div>
                </div>`;
            }).join('');

            container.innerHTML = `<div class="bg-white rounded-3xl shadow-sm border border-gray-100 p-5"><h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-trophy text-amber-400"></i> Peringkat Konsistensi</h3>${listHTML}</div>`;
        }
        window.addEventListener("DOMContentLoaded", boot);
</script>
</body>
</html>
